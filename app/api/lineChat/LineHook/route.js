// ‚úÖ ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≥ (‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß)
let chatHistory = []; // [{ userId, displayName, messages: [{ from, text, timestamp }] }]

// ‚úÖ ‡πÉ‡∏ä‡πâ LINE Messaging API ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏•‡∏±‡∏ö‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
async function sendLineMessage(userId, text) {
  const token = process.env.LINE_ACCESS_TOKEN;
  if (!token) throw new Error("LINE_ACCESS_TOKEN not set");

  await fetch("https://api.line.me/v2/bot/message/push", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "Authorization": `Bearer ${token}`,
    },
    body: JSON.stringify({
      to: userId,
      messages: [{ type: "text", text }],
    }),
  });
}

// ‚úÖ POST: ‡∏£‡∏±‡∏ö webhook ‡∏à‡∏≤‡∏Å LINE ‡∏´‡∏£‡∏∑‡∏≠‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≤‡∏Å UI
export async function POST(req) {
  try {
    const body = await req.json();

    // üü¢ ‡πÄ‡∏Ñ‡∏™ 1: LINE webhook ‡∏™‡πà‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤
    if (body?.events) {
      const event = body.events[0];
      if (!event) return Response.json({ ok: true });

      const userId = event.source?.userId;
      const message = event.message?.text;
      const timestamp = new Date(event.timestamp);
      const displayName = `User-${userId.slice(-4)}`;

      let user = chatHistory.find(u => u.userId === userId);
      if (!user) {
        user = { userId, displayName, messages: [] };
        chatHistory.push(user);
      }

      user.messages.push({ from: "customer", text: message, timestamp });

      console.log(`üì© From ${displayName}: ${message}`);
      return Response.json({ ok: true });
    }

    // üü¢ ‡πÄ‡∏Ñ‡∏™ 2: UI ‡∏ù‡∏±‡πà‡∏á‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
    if (body?.userId && body?.text) {
      const { userId, text } = body;

      // ‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏´‡∏≤ LINE ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤
      await sendLineMessage(userId, text);

      // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ù‡∏±‡πà‡∏á‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÉ‡∏ô history
      const user = chatHistory.find(u => u.userId === userId);
      if (user) {
        user.messages.push({ from: "agent", text, timestamp: new Date() });
      }

      console.log(`üì§ Sent to ${userId}: ${text}`);
      return Response.json({ ok: true });
    }

    return Response.json({ error: "Invalid POST data" }, { status: 400 });
  } catch (err) {
    console.error("‚ùå Error:", err);
    return Response.json({ error: err.message }, { status: 500 });
  }
}

// ‚úÖ GET: ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÅ‡∏ä‡∏ó‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
export async function GET() {
  return Response.json(chatHistory);
}
